---
title: "HMM training Bach"
output: html_notebook
---

```{r}

```


```{r}
setwd("C:/Users/Xinru/Documents/wheaton/thesis/R/Bach_Fugue/wav")
Bamfcc1 <- data.frame(read.csv("Bachmfcc1.csv", header=F))
split.Bamfcc1 <- split(Bamfcc1, (seq(nrow(Bamfcc1))-1) %/% 30)
#lapply(splitBamfcc1,dim)
Bach1.mean.list <- list()
for (i in 1:length(split.Bamfcc1)){
  Bach1.mean.list[[i]] <- as.vector(apply(split.Bamfcc1[[i]], MARGIN=2, FUN = "mean"))
}
Bach1.mean.list <- data.frame(Bach1.mean.list)
colnames(Bach1.mean.list)<-c(paste(rep("group", ncol(Bach1.mean.list)), seq(1:length(split.Bamfcc1))))

#determine the state numbers and GMM clustering
k.max <- 20
wss <- sapply(1:k.max, 
              function(k){kmeans(t(Bach1.mean.list), k)$tot.withinss})
wss
plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")
BIC <- mclustBIC(t(Bach1.mean.list))
plot(BIC)
mod1 <- Mclust(t(Bach1.mean.list), x = BIC)
summary(mod1, parameters = TRUE)


```

```{r}
#model training
#model training
J=mod1$G
init0 <- rep(1/J, J)
P <- matrix(rep(1/J, J*J), ncol = J)
B0 <- list(mu = list(mod1$parameters$mean[,1], mod1$parameters$mean[,2], mod1$parameters$mean[,3]), sigma = list(mod1$parameters$variance$sigma[,,1], mod1$parameters$variance$sigma[,,2], mod1$parameters$variance$sigma[,,3]))
#setwd("C:/Users/Xinru/Documents/wheaton/thesis/R/Bach_Fugue/wav")
#Bamfcc1_2 <- data.frame(read.csv("Bachmfcc1_2.csv", header=F))
train<-list(x=Bamfcc1, N=dim(Bamfcc1)[1])
class(train) <- "hsmm.data"
startval <- hmmspec(init0, P, parms.emis = B0, dens.emis = dmvnorm.hsmm)
hmv <- hmmfit(train, startval, mstep = mstep.mvnorm)
#train1_2 <- list(x=Bamfcc1_2, N=dim(Bamfcc1_2)[1])
#class(train1_2) <- "hsmm.data"
#make the starting probability uniform
#hmv$model$init <- rep(1/J, J) 
#hmv <- hmmfit(train1_2, hmv$model, mstep = mstep.mvnorm)
hmv$loglik
```

